From cccd0a509cac5c9f13f79dd408496bd58fec4320 Mon Sep 17 00:00:00 2001
From: Daniel Krol <orblivion@gmail.com>
Date: Tue, 26 Oct 2021 21:33:40 -0400
Subject: [PATCH 05/20] Automatically initialize author name from
 x-sandstorm-username

---
 src/node/handler/PadMessageHandler.js | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/node/handler/PadMessageHandler.js b/src/node/handler/PadMessageHandler.js
index c048c2fd..a223ea3f 100644
--- a/src/node/handler/PadMessageHandler.js
+++ b/src/node/handler/PadMessageHandler.js
@@ -823,6 +823,13 @@ const handleClientReady = async (socket, message) => {
   await hooks.aCallAll('clientReady', message); // Deprecated due to awkward context.
 
   let {colorId: authorColorId, name: authorName} = message.userInfo || {};
+
+  // SANDSTORM EDIT: Initialize the author name from the Sandstorm display name.
+  if (!authorName) {
+    authorName = decodeURIComponent(socket.client.request.headers["x-sandstorm-username"]);
+  }
+  // END SANDSTORM EDIT
+
   if (authorColorId && !/^#(?:[0-9A-F]{3}){1,2}$/i.test(authorColorId)) {
     messageLogger.warn(`Ignoring invalid colorId in CLIENT_READY message: ${authorColorId}`);
     authorColorId = null;
-- 
2.39.0

